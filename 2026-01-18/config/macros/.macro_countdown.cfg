[gcode_macro COUNTDOWN]
variable_current: 0
variable_update_duration: 1
variable_on_complete_macro: ''
gcode:
  {% set duration = params.DURATION | default(60) | int %}
  {% set update_dur = params.UPDATE_DURATION | default(1) | int %}
  {% set on_complete = params.ON_COMPLETE | default('') %}

  SET_GCODE_VARIABLE MACRO=COUNTDOWN VARIABLE=update_duration VALUE={update_dur}
  SET_GCODE_VARIABLE MACRO=COUNTDOWN VARIABLE=on_complete_macro VALUE='"{on_complete}"'
  SET_GCODE_VARIABLE MACRO=COUNTDOWN VARIABLE=current VALUE={duration - update_dur}
  
  UPDATE_DELAYED_GCODE ID=_COUNTDOWN_LOOP DURATION={update_dur}

[delayed_gcode _COUNTDOWN_LOOP]
gcode:
  {% set vars = printer["gcode_macro COUNTDOWN"] %}
  {% set current = vars.current %}

  SET_GCODE_VARIABLE MACRO=COUNTDOWN VARIABLE=current VALUE={current - vars.update_duration}

  {% if current > 0 %}
    M117 Remaining: {current}
    {action_respond_info("Countdown: %i remaining" % (current))}
    UPDATE_DELAYED_GCODE ID=_COUNTDOWN_LOOP DURATION={vars.update_duration}
  {% else %}
    M117 Countdown complete
    {action_respond_info("Countdown complete")}
    UPDATE_DELAYED_GCODE ID=_COUNTDOWN_LOOP DURATION=0

    {% if vars.on_complete_macro != '' %}
      {vars.on_complete_macro}
    {% endif %}
  {% endif %}
